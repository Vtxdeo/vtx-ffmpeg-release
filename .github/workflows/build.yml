name: Build Universal VTX FFmpeg

on:
  push:
    tags: ['v*']
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build_turbo:
    name: ${{ matrix.os }}-${{ matrix.arch }}-${{ matrix.profile }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # === Linux x86_64 (Musl Static - 修复版) ===
          # 基础类
          - os: linux
            arch: x86_64
            profile: nano
            toolchain_url: "https://musl.cc/x86_64-linux-musl-cross.tgz"
            toolchain_bin: "x86_64-linux-musl-cross/bin"
          - os: linux
            arch: x86_64
            profile: micro
            toolchain_url: "https://musl.cc/x86_64-linux-musl-cross.tgz"
            toolchain_bin: "x86_64-linux-musl-cross/bin"
          - os: linux
            arch: x86_64
            profile: mini
            toolchain_url: "https://musl.cc/x86_64-linux-musl-cross.tgz"
            toolchain_bin: "x86_64-linux-musl-cross/bin"
          - os: linux
            arch: x86_64
            profile: full
            toolchain_url: "https://musl.cc/x86_64-linux-musl-cross.tgz"
            toolchain_bin: "x86_64-linux-musl-cross/bin"

          # 垂直场景类
          - os: linux
            arch: x86_64
            profile: stream
            toolchain_url: "https://musl.cc/x86_64-linux-musl-cross.tgz"
            toolchain_bin: "x86_64-linux-musl-cross/bin"
          - os: linux
            arch: x86_64
            profile: indexer
            toolchain_url: "https://musl.cc/x86_64-linux-musl-cross.tgz"
            toolchain_bin: "x86_64-linux-musl-cross/bin"
          - os: linux
            arch: x86_64
            profile: audio
            toolchain_url: "https://musl.cc/x86_64-linux-musl-cross.tgz"
            toolchain_bin: "x86_64-linux-musl-cross/bin"
          - os: linux
            arch: x86_64
            profile: remux
            toolchain_url: "https://musl.cc/x86_64-linux-musl-cross.tgz"
            toolchain_bin: "x86_64-linux-musl-cross/bin"
          - os: linux
            arch: x86_64
            profile: transcode
            toolchain_url: "https://musl.cc/x86_64-linux-musl-cross.tgz"
            toolchain_bin: "x86_64-linux-musl-cross/bin"
          - os: linux
            arch: x86_64
            profile: animator
            toolchain_url: "https://musl.cc/x86_64-linux-musl-cross.tgz"
            toolchain_bin: "x86_64-linux-musl-cross/bin"
          - os: linux
            arch: x86_64
            profile: vod
            toolchain_url: "https://musl.cc/x86_64-linux-musl-cross.tgz"
            toolchain_bin: "x86_64-linux-musl-cross/bin"
          - os: linux
            arch: x86_64
            profile: archive
            toolchain_url: "https://musl.cc/x86_64-linux-musl-cross.tgz"
            toolchain_bin: "x86_64-linux-musl-cross/bin"

          # 特殊类
          - os: linux
            arch: x86_64
            profile: debug
            toolchain_url: "https://musl.cc/x86_64-linux-musl-cross.tgz"
            toolchain_bin: "x86_64-linux-musl-cross/bin"
          - os: linux
            arch: x86_64
            profile: legacy
            toolchain_url: "https://musl.cc/x86_64-linux-musl-cross.tgz"
            toolchain_bin: "x86_64-linux-musl-cross/bin"

          # === Windows x86_64 (MinGW) ===
          - os: win
            arch: x86_64
            profile: micro
          - os: win
            arch: x86_64
            profile: full
          - os: win
            arch: x86_64
            profile: transcode

          # === ARM64 (树莓派4/5, ARM服务器, 电视盒子) ===
          - os: linux
            arch: arm64
            profile: micro
            toolchain_url: "https://musl.cc/aarch64-linux-musl-cross.tgz"
            toolchain_bin: "aarch64-linux-musl-cross/bin"
          - os: linux
            arch: arm64
            profile: mini
            toolchain_url: "https://musl.cc/aarch64-linux-musl-cross.tgz"
            toolchain_bin: "aarch64-linux-musl-cross/bin"
          - os: linux
            arch: arm64
            profile: stream
            toolchain_url: "https://musl.cc/aarch64-linux-musl-cross.tgz"
            toolchain_bin: "aarch64-linux-musl-cross/bin"
          - os: linux
            arch: arm64
            profile: transcode
            toolchain_url: "https://musl.cc/aarch64-linux-musl-cross.tgz"
            toolchain_bin: "aarch64-linux-musl-cross/bin"

          # === ARMv7 (树莓派3, 老机顶盒) ===
          - os: linux
            arch: armv7
            profile: nano
            toolchain_url: "https://musl.cc/arm-linux-musleabi-cross.tgz"
            toolchain_bin: "arm-linux-musleabi-cross/bin"
          - os: linux
            arch: armv7
            profile: legacy
            toolchain_url: "https://musl.cc/arm-linux-musleabi-cross.tgz"
            toolchain_bin: "arm-linux-musleabi-cross/bin"
          - os: linux
            arch: armv7
            profile: stream
            toolchain_url: "https://musl.cc/arm-linux-musleabi-cross.tgz"
            toolchain_bin: "arm-linux-musleabi-cross/bin"

          # === MIPS (路由器: MT7620/7621, K2P) ===
          - os: linux
            arch: mipsel
            profile: nano
            toolchain_url: "https://musl.cc/mipsel-linux-musl-cross.tgz"
            toolchain_bin: "mipsel-linux-musl-cross/bin"
          - os: linux
            arch: mipsel
            profile: legacy
            toolchain_url: "https://musl.cc/mipsel-linux-musl-cross.tgz"
            toolchain_bin: "mipsel-linux-musl-cross/bin"

          # === RISC-V (开发板) ===
          - os: linux
            arch: riscv64
            profile: micro
            toolchain_url: "https://musl.cc/riscv64-linux-musl-cross.tgz"
            toolchain_bin: "riscv64-linux-musl-cross/bin"

    steps:
      - name: Checkout FFmpeg Source
        uses: actions/checkout@v4
        with:
          repository: FFmpeg/FFmpeg
          ref: n6.1

      - name: Checkout VTX Configs
        uses: actions/checkout@v4
        with:
          path: vtx-config

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential yasm nasm pkg-config ccache mingw-w64 wget tar

      - name: Setup CCache
        uses: actions/cache@v3
        with:
          path: ~/.ccache
          key: ccache-${{ matrix.os }}-${{ matrix.arch }}-${{ matrix.profile }}-${{ github.sha }}
          restore-keys: |
            ccache-${{ matrix.os }}-${{ matrix.arch }}-${{ matrix.profile }}-

      - name: Setup Cross Toolchain
        if: matrix.toolchain_url != ''
        run: |
          echo "Downloading toolchain from ${{ matrix.toolchain_url }}..."
          wget --tries=5 --waitretry=5 --retry-connrefused -q -O toolchain.tgz ${{ matrix.toolchain_url }}
          
          tar -xf toolchain.tgz
          DIR_NAME=$(tar -tf toolchain.tgz | head -1 | cut -f1 -d"/")
          echo "$(pwd)/$DIR_NAME/bin" >> $GITHUB_PATH

      - name: Run Build Script
        run: |
          chmod +x vtx-config/scripts/build.sh
          export PATH="/usr/lib/ccache:$PATH"

          ./vtx-config/scripts/build.sh ${{ matrix.profile }} ${{ matrix.os }} ${{ matrix.arch }} ${{ github.ref_name }}

      - name: Generate Checksums
        run: |
          cd dist
          sha256sum * > checksums.txt
          echo "Checksums generated:"
          cat checksums.txt

      - name: Upload Artifacts
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            dist/*
            dist/checksums.txt