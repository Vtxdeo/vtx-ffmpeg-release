name: Build Universal VTX FFmpeg

on:
  push:
    tags: ['v*']
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build_turbo:
    name: ${{ matrix.os }}-${{ matrix.arch }}-${{ matrix.profile }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # === Linux x86_64 (旗舰全覆盖) ===
          - os: linux
            arch: x86_64
            profile: nano
            use_toolchain: true
          - os: linux
            arch: x86_64
            profile: micro
            use_toolchain: true
          - os: linux
            arch: x86_64
            profile: mini
            use_toolchain: true
          - os: linux
            arch: x86_64
            profile: full
            use_toolchain: true
          - os: linux
            arch: x86_64
            profile: stream
            use_toolchain: true
          - os: linux
            arch: x86_64
            profile: indexer
            use_toolchain: true
          - os: linux
            arch: x86_64
            profile: audio
            use_toolchain: true
          - os: linux
            arch: x86_64
            profile: remux
            use_toolchain: true
          - os: linux
            arch: x86_64
            profile: transcode
            use_toolchain: true
          - os: linux
            arch: x86_64
            profile: animator
            use_toolchain: true
          - os: linux
            arch: x86_64
            profile: vod
            use_toolchain: true
          - os: linux
            arch: x86_64
            profile: archive
            use_toolchain: true
          - os: linux
            arch: x86_64
            profile: debug
            use_toolchain: true
          - os: linux
            arch: x86_64
            profile: legacy
            use_toolchain: true

          # === Windows x86_64 ===
          - os: win
            arch: x86_64
            profile: micro
          - os: win
            arch: x86_64
            profile: full
          - os: win
            arch: x86_64
            profile: transcode

          # === ARM64 ===
          - os: linux
            arch: arm64
            profile: micro
            use_toolchain: true
          - os: linux
            arch: arm64
            profile: mini
            use_toolchain: true
          - os: linux
            arch: arm64
            profile: stream
            use_toolchain: true
          - os: linux
            arch: arm64
            profile: transcode
            use_toolchain: true

          # === ARMv7 ===
          - os: linux
            arch: armv7
            profile: nano
            use_toolchain: true
          - os: linux
            arch: armv7
            profile: legacy
            use_toolchain: true
          - os: linux
            arch: armv7
            profile: stream
            use_toolchain: true

          # === MIPS ===
          - os: linux
            arch: mipsel
            profile: nano
            use_toolchain: true
          - os: linux
            arch: mipsel
            profile: legacy
            use_toolchain: true

          # === RISC-V ===
          - os: linux
            arch: riscv64
            profile: micro
            use_toolchain: true

    steps:
      - name: Checkout FFmpeg Source
        uses: actions/checkout@v4
        with:
          repository: FFmpeg/FFmpeg
          ref: n6.1

      - name: Checkout VTX Configs
        uses: actions/checkout@v4
        with:
          path: vtx-config

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential yasm nasm pkg-config ccache mingw-w64 curl tar

      - name: Setup CCache
        uses: actions/cache@v3
        with:
          path: ~/.ccache
          key: ccache-${{ matrix.os }}-${{ matrix.arch }}-${{ matrix.profile }}-${{ github.sha }}
          restore-keys: |
            ccache-${{ matrix.os }}-${{ matrix.arch }}-${{ matrix.profile }}-

      - name: Cache Cross Toolchain
        id: cache-toolchain
        if: matrix.use_toolchain == true
        uses: actions/cache@v3
        with:
          path: toolchain_dir
          key: toolchain-v1-${{ matrix.arch }}-${{ hashFiles('vtx-config/scripts/build.sh') }}

      - name: Setup VTX Toolchain
        if: matrix.use_toolchain == true && steps.cache-toolchain.outputs.cache-hit != 'true'
        run: |
          ARCH_MAP="${{ matrix.arch }}"
          [[ "$ARCH_MAP" == "arm64" ]] && ARCH_MAP="aarch64"
          [[ "$ARCH_MAP" == "armv7" ]] && ARCH_MAP="arm-linux-musleabi"

          REPO_URL="https://github.com/Vtxdeo/vtx-toolchains/releases/download/toolchain-latest/${ARCH_MAP}-linux-musl-cross.tgz"
          
          echo ">>> 正在从 VTX 镜像仓库下载工具链: $REPO_URL"
          mkdir -p toolchain_dir

          curl -L --retry 5 --retry-delay 10 -o toolchain.tgz "$REPO_URL"
          tar -xf toolchain.tgz -C toolchain_dir --strip-components=1
          rm toolchain.tgz

      - name: Add Toolchain to Path
        if: matrix.use_toolchain == true
        run: echo "$(pwd)/toolchain_dir/bin" >> $GITHUB_PATH

      - name: Run Build Script
        run: |
          chmod +x vtx-config/scripts/build.sh
          export PATH="/usr/lib/ccache:$PATH"
          ./vtx-config/scripts/build.sh ${{ matrix.profile }} ${{ matrix.os }} ${{ matrix.arch }} ${{ github.ref_name }}

      - name: Generate Checksums
        run: |
          cd dist
          sha256sum * > checksums.txt

      - name: Upload Artifacts
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            dist/*
            dist/checksums.txt