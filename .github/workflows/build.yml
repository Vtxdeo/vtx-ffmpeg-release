name: Build Universal VTX FFmpeg

on:
  push:
    tags: ['v*']
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build_turbo:
    name: ${{ matrix.os }}-${{ matrix.arch }}-${{ matrix.profile }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # === Linux x86_64 (Musl Static) ===
          - os: linux
            arch: x86_64
            profile: nano
            toolchain_url: "https://musl.cc/x86_64-linux-musl-cross.tgz"
          - os: linux
            arch: x86_64
            profile: micro
            toolchain_url: "https://musl.cc/x86_64-linux-musl-cross.tgz"
          - os: linux
            arch: x86_64
            profile: mini
            toolchain_url: "https://musl.cc/x86_64-linux-musl-cross.tgz"
          - os: linux
            arch: x86_64
            profile: full
            toolchain_url: "https://musl.cc/x86_64-linux-musl-cross.tgz"
          - os: linux
            arch: x86_64
            profile: stream
            toolchain_url: "https://musl.cc/x86_64-linux-musl-cross.tgz"
          - os: linux
            arch: x86_64
            profile: indexer
            toolchain_url: "https://musl.cc/x86_64-linux-musl-cross.tgz"
          - os: linux
            arch: x86_64
            profile: audio
            toolchain_url: "https://musl.cc/x86_64-linux-musl-cross.tgz"
          - os: linux
            arch: x86_64
            profile: remux
            toolchain_url: "https://musl.cc/x86_64-linux-musl-cross.tgz"
          - os: linux
            arch: x86_64
            profile: transcode
            toolchain_url: "https://musl.cc/x86_64-linux-musl-cross.tgz"
          - os: linux
            arch: x86_64
            profile: animator
            toolchain_url: "https://musl.cc/x86_64-linux-musl-cross.tgz"
          - os: linux
            arch: x86_64
            profile: vod
            toolchain_url: "https://musl.cc/x86_64-linux-musl-cross.tgz"
          - os: linux
            arch: x86_64
            profile: archive
            toolchain_url: "https://musl.cc/x86_64-linux-musl-cross.tgz"
          - os: linux
            arch: x86_64
            profile: debug
            toolchain_url: "https://musl.cc/x86_64-linux-musl-cross.tgz"
          - os: linux
            arch: x86_64
            profile: legacy
            toolchain_url: "https://musl.cc/x86_64-linux-musl-cross.tgz"

          # === Windows x86_64 ===
          - os: win
            arch: x86_64
            profile: micro
          - os: win
            arch: x86_64
            profile: full
          - os: win
            arch: x86_64
            profile: transcode

          # === ARM64 ===
          - os: linux
            arch: arm64
            profile: micro
            toolchain_url: "https://musl.cc/aarch64-linux-musl-cross.tgz"
          - os: linux
            arch: arm64
            profile: mini
            toolchain_url: "https://musl.cc/aarch64-linux-musl-cross.tgz"
          - os: linux
            arch: arm64
            profile: stream
            toolchain_url: "https://musl.cc/aarch64-linux-musl-cross.tgz"
          - os: linux
            arch: arm64
            profile: transcode
            toolchain_url: "https://musl.cc/aarch64-linux-musl-cross.tgz"

          # === ARMv7 ===
          - os: linux
            arch: armv7
            profile: nano
            toolchain_url: "https://musl.cc/arm-linux-musleabi-cross.tgz"
          - os: linux
            arch: armv7
            profile: legacy
            toolchain_url: "https://musl.cc/arm-linux-musleabi-cross.tgz"
          - os: linux
            arch: armv7
            profile: stream
            toolchain_url: "https://musl.cc/arm-linux-musleabi-cross.tgz"

          # === MIPS ===
          - os: linux
            arch: mipsel
            profile: nano
            toolchain_url: "https://musl.cc/mipsel-linux-musl-cross.tgz"
          - os: linux
            arch: mipsel
            profile: legacy
            toolchain_url: "https://musl.cc/mipsel-linux-musl-cross.tgz"

          # === RISC-V ===
          - os: linux
            arch: riscv64
            profile: micro
            toolchain_url: "https://musl.cc/riscv64-linux-musl-cross.tgz"

    steps:
      - name: Checkout FFmpeg Source
        uses: actions/checkout@v4
        with:
          repository: FFmpeg/FFmpeg
          ref: n6.1

      - name: Checkout VTX Configs
        uses: actions/checkout@v4
        with:
          path: vtx-config

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential yasm nasm pkg-config ccache mingw-w64 wget tar

      - name: Setup CCache
        uses: actions/cache@v3
        with:
          path: ~/.ccache
          key: ccache-${{ matrix.os }}-${{ matrix.arch }}-${{ matrix.profile }}-${{ github.sha }}
          restore-keys: |
            ccache-${{ matrix.os }}-${{ matrix.arch }}-${{ matrix.profile }}-

      - name: Cache Cross Toolchain
        id: cache-toolchain
        if: matrix.toolchain_url != ''
        uses: actions/cache@v3
        with:
          path: toolchain_dir
          key: toolchain-${{ matrix.arch }}-${{ hashFiles('vtx-config/scripts/build.sh') }}

      - name: Setup Cross Toolchain
        if: matrix.toolchain_url != '' && steps.cache-toolchain.outputs.cache-hit != 'true'
        run: |
          echo "Downloading toolchain..."
          mkdir -p toolchain_dir
          # 优先使用预托管的 Release 地址（此处假设你已上传），若失败则回退 musl.cc
          # 你可以将下方的 URL 替换为你托管工具链的具体 GitHub Release URL
          wget --tries=5 --waitretry=10 --retry-connrefused -q -O toolchain.tgz ${{ matrix.toolchain_url }}
          tar -xf toolchain.tgz -C toolchain_dir --strip-components=1

      - name: Add Toolchain to Path
        if: matrix.toolchain_url != ''
        run: |
          echo "$(pwd)/toolchain_dir/bin" >> $GITHUB_PATH

      - name: Run Build Script
        run: |
          chmod +x vtx-config/scripts/build.sh
          export PATH="/usr/lib/ccache:$PATH"
          ./vtx-config/scripts/build.sh ${{ matrix.profile }} ${{ matrix.os }} ${{ matrix.arch }} ${{ github.ref_name }}

      - name: Generate Checksums
        run: |
          cd dist
          sha256sum * > checksums.txt

      - name: Upload Artifacts
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            dist/*
            dist/checksums.txt