name: Build Universal VTX FFmpeg

on:
  push:
    tags: ['v*']  # Triggered by pushing version tags
  workflow_dispatch:  # Supports manual triggering of the workflow

permissions:
  contents: write  # Allows write access to the contents

jobs:
  build_turbo:
    name: ${{ matrix.os }}-${{ matrix.arch }}-${{ matrix.profile }}  # Display OS, architecture, and profile
    runs-on: ubuntu-latest  # Use the latest Ubuntu environment
    strategy:
      fail-fast: false  # Continue building other platforms on failure
      matrix:
        include:
          # === Linux x86_64 Architecture ===
          - os: linux
            arch: x86_64
            profile: nano
            use_toolchain: true
          - os: linux
            arch: x86_64
            profile: micro
            use_toolchain: true
          - os: linux
            arch: x86_64
            profile: mini
            use_toolchain: true
          - os: linux
            arch: x86_64
            profile: full
            use_toolchain: true
          - os: linux
            arch: x86_64
            profile: stream
            use_toolchain: true
          - os: linux
            arch: x86_64
            profile: indexer
            use_toolchain: true
          - os: linux
            arch: x86_64
            profile: audio
            use_toolchain: true
          - os: linux
            arch: x86_64
            profile: remux
            use_toolchain: true
          - os: linux
            arch: x86_64
            profile: transcode
            use_toolchain: true
          - os: linux
            arch: x86_64
            profile: animator
            use_toolchain: true
          - os: linux
            arch: x86_64
            profile: vod
            use_toolchain: true
          - os: linux
            arch: x86_64
            profile: archive
            use_toolchain: true
          - os: linux
            arch: x86_64
            profile: debug
            use_toolchain: true
          - os: linux
            arch: x86_64
            profile: legacy
            use_toolchain: true

          # === Windows x86_64 Architecture ===
          - os: win
            arch: x86_64
            profile: micro
          - os: win
            arch: x86_64
            profile: full
          - os: win
            arch: x86_64
            profile: transcode

          # === ARM64 Architecture ===
          - os: linux
            arch: arm64
            profile: micro
            use_toolchain: true
          - os: linux
            arch: arm64
            profile: mini
            use_toolchain: true
          - os: linux
            arch: arm64
            profile: stream
            use_toolchain: true
          - os: linux
            arch: arm64
            profile: transcode
            use_toolchain: true

          # === ARMv7 Architecture ===
          - os: linux
            arch: armv7
            profile: nano
            use_toolchain: true
          - os: linux
            arch: armv7
            profile: legacy
            use_toolchain: true
          - os: linux
            arch: armv7
            profile: stream
            use_toolchain: true

          # === MIPS Architecture ===
          - os: linux
            arch: mipsel
            profile: nano
            use_toolchain: true
          - os: linux
            arch: mipsel
            profile: legacy
            use_toolchain: true

          # === RISC-V Architecture ===
          - os: linux
            arch: riscv64
            profile: micro
            use_toolchain: true

    steps:
      - name: Checkout FFmpeg Source
        uses: actions/checkout@v4
        with:
          repository: FFmpeg/FFmpeg
          ref: n6.1  # Use FFmpeg version 6.1

      - name: Checkout VTX Configs
        uses: actions/checkout@v4
        with:
          path: vtx-config  # Checkout VTX configuration files

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential yasm nasm pkg-config ccache mingw-w64 curl tar
          # Install build dependencies

      - name: Setup CCache
        uses: actions/cache@v3
        with:
          path: ~/.ccache
          key: ccache-${{ matrix.os }}-${{ matrix.arch }}-${{ matrix.profile }}-${{ github.sha }}
          restore-keys: |
            ccache-${{ matrix.os }}-${{ matrix.arch }}-${{ matrix.profile }}-

      - name: Cache Cross Toolchain
        id: cache-toolchain
        if: matrix.use_toolchain == true
        uses: actions/cache@v3
        with:
          path: toolchain_dir
          key: toolchain-v1-${{ matrix.arch }}-${{ hashFiles('vtx-config/scripts/build.sh') }}

      - name: Setup VTX Toolchain
        if: matrix.use_toolchain == true && steps.cache-toolchain.outputs.cache-hit != 'true'
        run: |
          ARCH_MAP="${{ matrix.arch }}"
          [[ "$ARCH_MAP" == "arm64" ]] && ARCH_MAP="aarch64"
          [[ "$ARCH_MAP" == "armv7" ]] && ARCH_MAP="arm-linux-musleabi"
          
          REPO_URL="https://github.com/Vtxdeo/vtx-toolchains/releases/download/toolchain-latest/${ARCH_MAP}-linux-musl-cross.tgz"
          
          echo ">>> Downloading toolchain from VTX repository: $REPO_URL"
          mkdir -p toolchain_dir
          curl -L --retry 5 --retry-delay 10 -o toolchain.tgz "$REPO_URL"
          tar -xf toolchain.tgz -C toolchain_dir --strip-components=1
          rm toolchain.tgz

      - name: Add Toolchain to Path
        if: matrix.use_toolchain == true
        run: echo "$(pwd)/toolchain_dir/bin" >> $GITHUB_PATH

      - name: Run Build Script
        run: |
          chmod +x vtx-config/scripts/build.sh
          export PATH="/usr/lib/ccache:$PATH"
          ./vtx-config/scripts/build.sh ${{ matrix.profile }} ${{ matrix.os }} ${{ matrix.arch }} ${{ github.ref_name }}

      - name: Generate Build Manifest
        run: |
          cd dist
          MANIFEST_NAME="manifest-${{ matrix.os }}-${{ matrix.arch }}-${{ matrix.profile }}.txt"
          cat <<EOF > $MANIFEST_NAME
          Product: VTX FFmpeg Static
          Version: ${{ github.ref_name }}
          Commit: ${{ github.sha }}
          Build-Date: $(date -u +'%Y-%m-%dT%H:%M:%SZ')
          Profile: ${{ matrix.profile }}
          Architecture: ${{ matrix.arch }}
          OS: ${{ matrix.os }}
          EOF

      - name: Generate Checksums
        run: |
          cd dist
          sha256sum * > checksums-${{ matrix.os }}-${{ matrix.arch }}-${{ matrix.profile }}.txt

      - name: Upload Artifacts
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            dist/*